sequenceDiagram
    participant ğŸ“± as Client
    participant ğŸ” as SHA-256 Hash
    participant â˜ï¸ as Cloud Functions
    participant ğŸ—‚ï¸ as phoneHashes
    participant ğŸ“Š as Firestore

    ğŸ“±->>ğŸ“±: Normalize Contacts (E.164)
    ğŸ“±->>ğŸ”: Request Phone Hashing
    ğŸ”-->>ğŸ“±: Return SHA-256 Hash
    
    Note over ğŸ“±: Raw phone numbers stay on client only
    
    ğŸ“±->>â˜ï¸: syncContacts(hash array)
    
    loop For Each Hash
        â˜ï¸->>ğŸ—‚ï¸: Query Reverse Index
        ğŸ—‚ï¸-->>â˜ï¸: Return Matched userId
        
        alt User Match Found
            â˜ï¸->>ğŸ“Š: Check User Settings
            
            alt allowPhoneSearch = true
                â˜ï¸->>ğŸ“Š: Update contactFriends
            end
        end
    end
    
    â˜ï¸-->>ğŸ“±: Return Sync Results
    
    Note over ğŸ—‚ï¸: Firestore Rules:<br/>allow read, write: if false<br/>(Blocks direct client access)
