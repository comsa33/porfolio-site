sequenceDiagram
    participant User as ì‚¬ìš©ì/Agent
    participant API as API Endpoint
    participant Proc as Processor
    participant Track as ProgressTracker
    participant Eval as Evaluator
    participant MinIO as MinIO Storage
    participant DH as DataHub API
    
    Note over User,DH: 1ë‹¨ê³„: QnA ë°ì´í„°ì…‹ ìƒì„±
    User->>+API: POST /generation/qna<br/>(collection_id, index_id, chat_logs_id)
    API->>+Proc: create_task(QnAGenerator)
    Proc->>Track: start("QnA ìƒì„±")
    Track->>DH: ğŸš€ QnA ìƒì„± 0% ì‹œì‘
    
    loop ê° ë¬¸ì„œ ì²˜ë¦¬
        Proc->>Eval: generate_qna_for_passage()
        Eval->>Eval: LLMìœ¼ë¡œ ì§ˆë¬¸/ë‹µë³€ ìƒì„±
        Proc->>Track: update(1)
        alt 10% ë„ë‹¬
            Track->>DH: â³ 10% ~ 100% ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
        end
    end
    
    Proc->>MinIO: save(qna_dataset.csv)
    MinIO-->>Proc: file_id
    Proc->>Track: complete([file_id])
    Track->>DH: âœ… QnA ìƒì„± ì™„ë£Œ
    Proc-->>-API: {status: "completed", files: [qna_dataset.csv]}
    API-->>-User: Response
    
    Note over User,DH: 2ë‹¨ê³„: Recall í‰ê°€ (ê²€ìƒ‰ ì •í™•ë„)
    User->>+API: POST /evaluation/passage<br/>(qna_file, top_k, chat_logs_id)
    API->>+Proc: create_task(RecallProcessor)
    Proc->>MinIO: load(qna_dataset.csv)
    MinIO-->>Proc: QnA data
    
    Proc->>Track: start("Recall í‰ê°€")
    Track->>DH: ğŸš€ Recall í‰ê°€ 0% ì‹œì‘
    
    loop ê° ì§ˆë¬¸ í‰ê°€
        Proc->>Eval: evaluate_recall(question)
        Eval->>DH: search_passages(query)
        DH-->>Eval: retrieved_passages
        Eval->>Eval: gold_passage ìˆœìœ„ í™•ì¸
        Proc->>Track: update(1)
        alt 10% ë„ë‹¬
            Track->>DH: â³ 10% ~ 100% ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
        end
    end
    
    Proc->>MinIO: save(recall_results.csv)
    MinIO-->>Proc: recall_file_id
    Proc->>MinIO: save(ragas_dataset.jsonl)
    MinIO-->>Proc: ragas_file_id
    Proc->>Track: complete([recall_file_id, ragas_file_id])
    Track->>DH: âœ… Recall í‰ê°€ ì™„ë£Œ
    Proc-->>-API: {status: "completed", files: [recall.csv, ragas.jsonl]}
    API-->>-User: Response
    
    Note over User,DH: 3ë‹¨ê³„: Ragas í‰ê°€ (ìƒì„± í’ˆì§ˆ)
    User->>+API: POST /evaluation/ragas<br/>(ragas_file, metrics, chat_logs_id)
    API->>+Proc: create_task(RagasProcessor)
    Proc->>MinIO: load(ragas_dataset.jsonl)
    MinIO-->>Proc: Ragas data
    
    Proc->>Track: start("Ragas í‰ê°€")
    Track->>DH: ğŸš€ Ragas í‰ê°€ 0% ì‹œì‘
    
    Proc->>Eval: evaluate_ragas_batch(data, metrics)
    Eval->>Eval: Faithfulness, Answer Relevancy,<br/>Context Precision, Context Recall ê³„ì‚°
    Proc->>Track: update(batch_size)
    Track->>DH: â³ ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
    
    Proc->>MinIO: save(ragas_results.csv)
    MinIO-->>Proc: result_file_id
    Proc->>Track: complete([result_file_id])
    Track->>DH: âœ… Ragas í‰ê°€ ì™„ë£Œ
    Proc-->>-API: {status: "completed", files: [ragas_results.csv]}
    API-->>-User: Response
    
    Note over User,DH: ë¹„ë™ê¸° ì²˜ë¦¬ (chat_logs_id ìˆì„ ê²½ìš°)
    rect rgb(255, 245, 200)
        Note right of Proc: asyncio.create_task()ë¡œ<br/>ë°±ê·¸ë¼ìš´ë“œ ì‹¤í–‰
        Note right of Track: ì‹¤ì‹œê°„ ì§„í–‰ë¥ ì„<br/>DataHubì— ì§€ì† ë³´ê³ 
    end
